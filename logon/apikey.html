<!DOCTYPE html>
<html lang="en">
<head>

 <meta charset="utf-8">
 <meta name="viewport"  content="width=device-width, initial-scale=1">

 <link rel="icon"       href="/favicon.ico">
 <link rel="stylesheet" href="/uikit/uikit.min.css">

 <script src="/uikit/uikit-all.min.js"></script>

 <title>Site API Logon</title>

</head>
<body class="uk-flex uk-flex-center uk-flex-middle uk-background-muted uk-height-viewport" data-uk-height-viewport>
 <div class="uk-section uk-section-muted uk-flex uk-flex-middle uk-animation-fade" uk-height-viewport uk-animation-fade>
  <div class="uk-width-1-1">
   <div class="uk-container">
    <div class="uk-grid-margin uk-grid uk-grid-stack" uk-grid>
     <div class="uk-width-5-6 uk-margin-auto">
      <div class="uk-card uk-card-default uk-card-large uk-grid-collapse uk-child-width-1-2@s uk-margin uk-border-rounded uk-position-relative uk-overflow-hidden" uk-grid>
       <div class="uk-flex-last@s uk-card-media-right uk-cover-container">
        <img src="/auth/logon/logo.webp" alt="" id="logo" uk-cover>
        <canvas width="600" height="400"></canvas>
       </div>
       <div>
        <div class="uk-card-body">
         <form id="loginform">
          <div class="uk-margin">
           <div class="uk-inline uk-width-1-1">
            <center><span class="uk-icon" uk-icon="icon: user; ratio: 4"></span></center>
           </div>
          </div>
          <div class="uk-margin">
           <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon" uk-icon="icon: user"></span>
            <input class="uk-input uk-form" id="inputUsername" type="text" placeholder="Username" required autofocus>
           </div>
          </div>
          <div class="uk-margin">
           <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon" uk-icon="icon: lock"></span>
            <input class="uk-input uk-form" id="inputPassword" type="text" placeholder="API Key" required>
           </div>
          </div>
          <div class="uk-margin">
           <div class="uk-form-controls">
            <button class="uk-button uk-button-primary uk-width-1-1" id="sbutton">Sign in</button>
           </div>
          </div>
         </form>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
 <div id="sanic-modal" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div id="sanic-modal-contents" class="uk-modal-body" uk-overflow-auto>...</div>
        <div class="uk-modal-footer uk-text-right">
            <button id="ack" class="uk-button uk-button-primary uk-modal-close" type="button">Acknowledge</button>
        </div>
    </div>
 </div>
 <script type='text/javascript'>

  //  $("#loginform").submit(function(e){
  //   var username = $('#inputUsername').val();
  //   var password = $('#inputPassword').val();
  //   $('#inputPassword').val('****');
  //   $('#sbutton').text('verifying');
  //   $('#sbutton').prop('disabled', true);
  //   $('#inputUsername').prop('disabled', true);
  //   $('#inputPassword').prop('disabled', true);
  //   $.ajax({
  //     url: '/auth/apikey',
  //     method: 'POST',
  //     dataType: 'json',
  //     contentType: 'application/json',
  //     data: JSON.stringify({ username: username, apikey: password }),
  //     success: function(result) {
  //       if (result['success']) {
  //         document.location = result['data']['redirect'];
  //       } else {
  //         $('#sbutton').text('sign in');
  //         $('#sbutton').prop('disabled', false);
  //         $('#inputUsername').prop('disabled', false);
  //         $('#inputPassword').prop('disabled', false);
  //         $('#inputPassword').val('');
  //         $('#inputPassword').focus();
  //       }
  //     }
  //   });
  //   e.preventDefault();
  // });

  document.getElementById('loginform').addEventListener('submit', function (e) {
    e.preventDefault();

    const usernameInput = document.getElementById('inputUsername');
    const passwordInput = document.getElementById('inputPassword');
    const submitButton = document.getElementById('sbutton');

    const username = usernameInput.value;
    const apikey = passwordInput.value;

    // Mask password visually
    passwordInput.value = '****';

    // Disable inputs and update button
    submitButton.textContent = 'verifying';
    submitButton.disabled = true;
    usernameInput.disabled = true;
    passwordInput.disabled = true;

    fetch('/auth/apikey', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ username: username, apikey: apikey })
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          document.location = result.data.redirect;
        } else {
          // Re-enable form and reset password field
          submitButton.textContent = 'sign in';
          submitButton.disabled = false;
          usernameInput.disabled = false;
          passwordInput.disabled = false;
          passwordInput.value = '';
          passwordInput.focus();
        }
      })
      .catch(error => {
        console.error('API key login error:', error);
        // Fallback UI on fetch error
        submitButton.textContent = 'sign in';
        submitButton.disabled = false;
        usernameInput.disabled = false;
        passwordInput.disabled = false;
        passwordInput.value = '';
        passwordInput.focus();
      });
  });


  fetch('/auth/info')
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(result => {
      if (result.success) {
        document.location = result.data.redirect;
      }

      if (result.data.logo !== '/auth/logon/logo.webp') {
        const logo = document.getElementById('logo');
        if (logo) {
          logo.setAttribute('src', result.data.logo);
        }
      }

      if (result.data.page_title && result.data.page_title !== '') {
        document.title = result.data.page_title;
      }

      if (result.data.message && result.data.message !== '') {
        const modalContent = document.getElementById('sanic-modal-contents');
        if (modalContent) {
          modalContent.innerHTML = result.data.message;
        }

        // Toggle UIkit modal
        if (typeof UIkit !== 'undefined' && UIkit.modal) {
          UIkit.modal("#sanic-modal").toggle();
        }

        const ackButton = document.getElementById('ack');
        if (ackButton) {
          ackButton.focus();
        }
      }
    })
    .catch(error => {
      console.error('Error fetching auth info:', error);
    });

 </script>
</body>
</html>
