<!DOCTYPE html>
<html lang="en">
<head>

 <meta charset="utf-8">
 <meta name="viewport"  content="width=device-width, initial-scale=1">

 <link rel="icon"       href="/favicon.ico">
 <link rel="stylesheet" href="/uikit/uikit.min.css">

 <script src="/uikit/uikit-all.min.js"></script>

 <title>Site Challenge Request</title>

</head>
<body class="uk-flex uk-flex-center uk-flex-middle uk-background-muted uk-height-viewport" data-uk-height-viewport>
 <div class="uk-section uk-section-muted uk-flex uk-flex-middle uk-animation-fade" uk-height-viewport uk-animation-fade>
  <div class="uk-width-1-1">
   <div class="uk-container">
    <div class="uk-grid-margin uk-grid uk-grid-stack" uk-grid>
     <div class="uk-width-5-6 uk-margin-auto">
      <div class="uk-card uk-card-default uk-card-large uk-grid-collapse uk-child-width-1-2@s uk-margin uk-border-rounded uk-position-relative uk-overflow-hidden" uk-grid>
       <div class="uk-flex-last@s uk-card-media-right uk-cover-container">
        <img src="/auth/logon/logo.webp" alt="" id="logo" uk-cover>
        <canvas width="600" height="400"></canvas>
       </div>
       <div>
        <div class="uk-card-body">
         <form id="loginform">
          <div class="uk-margin">
           <div class="uk-inline uk-width-1-1">
            <center><span class="uk-icon" uk-icon="icon: user; ratio: 4"></span></center>
           </div>
          </div>
          <div class="uk-margin">
           <br><br>
           <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon" uk-icon="icon: user"></span>
            <input class="uk-input uk-form" id="inputUsername" type="text" placeholder="Username" required autofocus>
           </div>
          </div>
          <div class="uk-margin">
           <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon" uk-icon="icon: lock"></span>
            <input class="uk-input uk-form" id="inputPassword" type="text" placeholder="Challenge Response" required disabled>
           </div>
          </div>
          <div class="uk-margin">
           <div class="uk-form-controls">
            <button class="uk-button uk-button-primary uk-width-1-1" id="sbutton">Send Email</button>
           </div>
          </div>
         </form>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
 <div id="sanic-modal" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div id="sanic-modal-contents" class="uk-modal-body" uk-overflow-auto>...</div>
        <div class="uk-modal-footer uk-text-right">
            <button id="ack" class="uk-button uk-button-primary uk-modal-close" type="button">Acknowledge</button>
        </div>
    </div>
 </div>
 <script type='text/javascript'>

   var currentStep = 'initial';

   document.getElementById('loginform').addEventListener('submit', function (e) {
    e.preventDefault();

    const usernameInput = document.getElementById('inputUsername');
    const passwordInput = document.getElementById('inputPassword');
    const submitButton = document.getElementById('sbutton');

    const username = usernameInput.value;
    const password = passwordInput.value;

    // Disable inputs
    submitButton.disabled = true;
    usernameInput.disabled = true;
    passwordInput.disabled = true;

    if (currentStep === 'initial') {
      submitButton.textContent = 'requesting';

      fetch('/auth/request/challenge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: username })
      })
        .then(response => {
          if (!response.ok) throw new Error('Challenge request failed');
          return response.json();
        })
        .then(result => {
          if (result.success) {
            currentStep = 'challenge';
            passwordInput.disabled = false;
            passwordInput.value = '';
            passwordInput.focus();
            submitButton.textContent = 'enter challenge';
            submitButton.disabled = false;
          }
        })
        .catch(error => {
          console.error('Challenge request error:', error);

          const modalContents = document.getElementById('sanic-modal-contents');
          if (modalContents) {
            modalContents.innerHTML =
              'This site has not been configured for challenge and response authentication, please contact the administrator or use a different logon method.';
          }

          if (typeof UIkit !== 'undefined' && UIkit.modal) {
            UIkit.modal('#sanic-modal').toggle();
          }
        });
    } else {
      submitButton.textContent = 'validating';
      passwordInput.value = '****';

      fetch('/auth/challenge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: username, challenge: password })
      })
        .then(response => {
          if (!response.ok) throw new Error('Challenge validation failed');
          return response.json();
        })
        .then(result => {
          if (result.success) {
            document.location = result.data.redirect;
          } else {
            passwordInput.disabled = false;
            passwordInput.value = '';
            passwordInput.focus();
            submitButton.textContent = 'enter challenge';
            submitButton.disabled = false;
          }
        })
        .catch(error => {
          console.error('Challenge validation error:', error);
          passwordInput.disabled = false;
          passwordInput.value = '';
          passwordInput.focus();
          submitButton.textContent = 'enter challenge';
          submitButton.disabled = false;
        });
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const reqUser = decodeURIComponent(urlParams.get('user'));

  const usernameInput = document.getElementById('inputUsername');
  const passwordInput = document.getElementById('inputPassword');
  const submitButton = document.getElementById('sbutton');

  if (reqUser && reqUser !== 'null') {
   if (usernameInput) {
     usernameInput.disabled = true;
     usernameInput.value = reqUser;
   }
   if (passwordInput) {
     passwordInput.disabled = false;
     passwordInput.value = '';
     passwordInput.focus();
   }
   if (submitButton) {
     submitButton.textContent = 'enter challenge';
     submitButton.disabled = false;
   }
   currentStep = 'challenge';
  }

  // Fetch auth info
  fetch('/auth/info')
   .then(response => {
     if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
     return response.json();
   })
   .then(result => {
     const data = result.data;

     if (result.success && data.redirect) {
       document.location = data.redirect;
       return; // skip UI updates after redirect
     }

     if (data.logo && data.logo !== '/auth/logon/logo.webp') {
       const logoEl = document.getElementById('logo');
       if (logoEl) {
         logoEl.setAttribute('src', data.logo);
       }
     }

     if (data.page_title && data.page_title.trim() !== '') {
       document.title = data.page_title;
     }

     if (data.message && data.message.trim() !== '') {
       const modalContents = document.getElementById('sanic-modal-contents');
       if (modalContents) {
         modalContents.innerHTML = data.message;
       }
       if (typeof UIkit !== 'undefined' && UIkit.modal) {
         UIkit.modal('#sanic-modal').toggle();
       }
       const ackBtn = document.getElementById('ack');
       if (ackBtn) {
         ackBtn.focus();
       }
     }
   })
   .catch(error => {
     console.error('Error loading /auth/info:', error);
   });
  });


 </script>
 </html>
